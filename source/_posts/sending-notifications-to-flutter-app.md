---
title: Sending Notifications to Flutter App
date: 2020-04-30 22:24:57
tags:
categories: Project
---

In this semester, our team tried to develop an mobile APP using Flutter. One user story is that when user are not using the APP, he/she should be notified when new friend request or new message coming

Since we are using firebase as our backend service, cloud functions can be used to monitor the database, and send notifications when triggered

<!--more-->

[This document](https://firebase.google.com/docs/functions/use-cases) provides a simple example:

![img](https://firebase.google.com/docs/functions/images/notify.png)

> 1. The function triggers on writes to the Realtime Database path where followers are stored.
> 2. The function composes a message to send via FCM.
> 3. FCM sends the notification message to the user's device.

## Cloud Functions

### Setting Triggers

Interactions between users is stored at `/users/{userId}/interactions/{interactionID}`in Cloud Firestore. Firebase SDK provide 4 triggers `onCreate`,`onUpdate`,`onDelete`,`onWrite`

In our case, we want to send a notification when user generate an interaction. So the function running on Node.js 8 should specify the document path and event type:

```javascript
const functions = require('firebase-functions');

exports.notificationFCM = functions.firestore
  .document('/users/{userId}/interactions/{interactionID}')
  .onCreate(async (snapshot, context) => { /* ... */ });
```

### Parse Data

Based on the data we need, we can set the [FCM messages](https://firebase.google.com/docs/cloud-messaging/concept-options) Notification messages will be displayed to end-user devices, data messages can be handled by client app and token is device registration token generated by FCM SDK in client app

For given platform, token can be got as follows

- iOS (Swift) — [`retrieveFCMTokenForSenderID:completion:`](https://firebase.google.com/docs/reference/swift/firebasemessaging/api/reference/Classes/Messaging#/c:objc(cs)FIRMessaging(im)retrieveFCMTokenForSenderID:completion:)
- Android — [`getToken()`](https://firebase.google.com/docs/reference/android/com/google/firebase/iid/FirebaseInstanceId#getToken(java.lang.String, java.lang.String))

Users can have multiple devices, however, for convenience, just assume that token is stored as a string under the user profile

The content of interaction is a JSON like data passed by snapshot

```json
{ metaData: {},
  readed: false,
  time: 1588268043715,
  title: 'Friend Request from Leaf',
  type: 'request',
  userMeta: 
   { displayName: 'Leaf',
     photoURL: '',
     uid: '' } 
 }
```

Once getting token and notification data, we can set the message

```javascript
const functions = require('firebase-functions');

exports.notificationFCM = functions.firestore
    .document('/users/{userId}/interactions/{interactionID}')
    .onCreate(async (snapshot, context) => {
        const interaction = snapshot.data();
        admin.firestore().collection('users').doc(context.params.userId).get().then((doc) => {
          const deviceToken = doc.get('deviceToken');
            var payload = {
              notification: {
                title: interaction.title,
              },
              data: {
                click_action: 'FLUTTER_NOTIFICATION_CLICK'
              },
              token: deviceToken
            };
        });
    });
```

### Sending Message via Firebase Cloud Messaging

This is very straight forward, sending the message to target device, then receiving response or error code

```javascript
const functions = require('firebase-functions');

exports.notificationFCM = functions.firestore
    .document('/users/{userId}/interactions/{interactionID}')
    .onCreate(async (snapshot, context) => {
        console.log(snapshot.data());
        const interaction = snapshot.data();
        admin.firestore().collection('users').doc(context.params.userId).get().then((doc) => {
          const deviceToken = doc.get('deviceToken');
          console.log(deviceToken)
            var payload = {
              notification: {
                title: interaction.title,
              },
              data: {
                click_action: 'FLUTTER_NOTIFICATION_CLICK'
              },
              token: deviceToken
            };
            // Send a message to the device corresponding to the provided
            // registration token.
            admin.messaging().send(payload)
              .then((response) => {
                // Response is a message ID string.
                console.log('Successfully sent message:', response);
              })
              .catch((error) => {
                console.log('Error sending message:', error);
              });
        });
    });

```

The cloud work is completed, next step is to make your device receive notifications

## Firebase Messaging

[Firebase Messaging](https://pub.dev/packages/firebase_messaging) is a flutter plugin for FCM, to use this, just update a dependency in the `pubspec.yaml`file

The [README](https://pub.dev/packages/firebase_messaging#-readme-tab-) file introduced how to integrate Firebase with your Android and IOS project, as we are using Cloud Storage and Firebase Auth. these part is already done yet. Then  import the plugin and instantiate it in the Dart code

```dart
import 'package:firebase_messaging/firebase_messaging.dart';
final FirebaseMessaging _firebaseMessaging = FirebaseMessaging();
```

BTW, The device token can be accessed by doing so

```dart
_firebaseMessaging.getToken().then((token) {
  print(token);
});
```